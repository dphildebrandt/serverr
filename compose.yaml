include:
  - $DOCKER_DIR/stacks/guacamole/compose.yaml
  - $DOCKER_DIR/stacks/rallly/compose.yaml

networks:
  t2_proxy:
    name: t2_proxy
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.90.0/24
  default:
    driver: bridge
  socket_proxy:
    name: socket_proxy
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.91.0/24

secrets:
  namecheap_api_user:
    file: $DOCKER_DIR/secrets/namecheap_api_user
  namecheap_api_key:
    file: $DOCKER_DIR/secrets/namecheap_api_key
  plex_claim:
    file: $DOCKER_DIR/secrets/plex_claim
  plex_token:
    file: $DOCKER_DIR/secrets/plex_token

  # This one loads secret into the config, so you need the following:
  # provider.google.client-id=
  # provider.google.client-secret=
  # secret=
  # whitelist=
  traefik-forward-auth:
    file: $DOCKER_DIR/secrets/traefik-forward-auth

x-environment: &default-tz-puid-pgid
  TZ: $TZ
  PUID: $PUID
  PGID: $PGID

x-networks: &network-sec
  networks:
    - t2_proxy
  security_opt:
    - no-new-privileges=true
  restart: unless-stopped

services:

  # SECURITY

  traefik:
    <<: *network-sec
    container_name: traefik
    image: traefik:latest
    command:
      - --global.checkNewVersion=true
      - --global.sendAnonymousUsage=false
      - --entryPoints.http.address=:80
      - --entryPoints.https.address=:443
      - --entryPoints.traefik.address=:8080
      - --api=true
      - --api.insecure=true
      - --log=true
      - --log.level=INFO
      - --log.filePath=/logs/traefik.log
      - --accessLog=true
      - --accessLog.filePath=/logs/access.log
      - --accessLog.bufferingSize=100
      - --accessLog.filters.statusCodes=204-299,400-499,500-599
      - --providers.docker=true
      - --providers.docker.endpoint=$SOCKET_PROXY
      - --entrypoints.https.http.tls.options=tls-opts@file
      - --providers.docker.exposedByDefault=false
      - --providers.docker.network=t2_proxy
      - --providers.docker.swarmMode=false
      - --providers.file.directory=/rules
      - --providers.file.watch=true
      - --entrypoints.https.http.tls.certresolver=dns-namecheap
      - --entrypoints.https.http.tls.domains[0].main=$DOMAIN_NAME
      - --entrypoints.https.http.tls.domains[0].sans=*.$DOMAIN_NAME
      #- --certificatesResolvers.dns-namecheap.acme.caServer=https://acme-staging-v02.api.letsencrypt.org/directory  # uncomment for testing
      - --certificatesResolvers.dns-namecheap.acme.email=$MY_EMAIL
      - --certificatesResolvers.dns-namecheap.acme.storage=/acme.json
      - --certificatesResolvers.dns-namecheap.acme.dnsChallenge.provider=namecheap
      - --certificatesResolvers.dns-namecheap.acme.dnsChallenge.resolvers=1.1.1.1:53,1.0.0.1:53
      - --certificatesResolvers.dns-namecheap.acme.dnsChallenge.delayBeforeCheck=90
    networks:
      - t2_proxy
      - socket_proxy
    ports:
      - target: 80
        published: 80
        protocol: tcp
        mode: host
      - target: 443
        published: 443
        protocol: tcp
        mode: host
    volumes:
      - $DOCKER_DIR/app-data/traefik/rules:/rules
      - $DOCKER_DIR/app-data/traefik/acme/acme.json:/acme.json
      - $DOCKER_DIR/logs/traefik:/logs
    secrets:
      - namecheap_api_user
      - namecheap_api_key
    environment:
      NAMECHEAP_API_USER_FILE: /run/secrets/namecheap_api_user
      NAMECHEAP_API_KEY_FILE: /run/secrets/namecheap_api_key
      DOMAIN_NAME: $DOMAIN_NAME
      WLED_IP: $WLED_IP
      HDHOMERUN_IP: $HDHOMERUN_IP
    labels:
      - "traefik.enable=true"
      # HTTP-to-HTTPS Redirect
      - "traefik.http.routers.http-catchall.entrypoints=http"
      - "traefik.http.routers.http-catchall.rule=HostRegexp(`{host:.+}`)"
      - "traefik.http.routers.http-catchall.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      # HTTP Routers
      - "traefik.http.routers.traefik-rtr.entrypoints=https"
      - "traefik.http.routers.traefik-rtr.rule=Host(`traefik.$DOMAIN_NAME`)"
      #- "traefik.http.routers.traefik-rtr.tls.certresolver=dns-namecheap"  # uncomment for first run of traefik, commented to force the use of wildcard certs
      - "traefik.http.routers.traefik-rtr.tls.domains[0].main=$DOMAIN_NAME"
      - "traefik.http.routers.traefik-rtr.tls.domains[0].sans=*.$DOMAIN_NAME"
      # Services - API
      - "traefik.http.routers.traefik-rtr.service=api@internal"
      # Middlewares
      - "traefik.http.routers.traefik-rtr.middlewares=chain-oauth@file"

  socket-proxy:
    container_name: socket-proxy
    image: tecnativa/docker-socket-proxy:latest
    restart: unless-stopped
    security_opt:
      - no-new-privileges=true
    networks:
      - socket_proxy
    privileged: true
    ports:
      - "127.0.0.1:2375:2375"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
    environment:
      - LOG_LEVEL=info
      # Granted by Default
      - EVENTS=1
      - PING=1
      - VERSION=1
      # Revoked by Default
      - AUTH=0
      - SECRETS=0
      - POST=1  # Watchtower
      # GET options
      - BUILD=0
      - COMMIT=0
      - CONFIGS=0
      - CONTAINERS=1  # Traefik, watchtower, homepage
      - DISTRIBUTION=0
      - EXEC=0
      - IMAGES=1  # watchtower
      - INFO=0
      - NETWORKS=1  # watchtower
      - NODES=0
      - PLUGINS=0
      - SERVICES=0
      - SESSION=0
      - SWARM=0
      - SYSTEM=0
      - TASKS=0
      - VOLUMES=0

  oauth:
    <<: *network-sec
    container_name: oauth
    image: thomseddon/traefik-forward-auth:latest
    environment:
      - CONFIG=/config
      - COOKIE_DOMAIN=$DOMAIN_NAME
      - INSECURE_COOKIE=false
      - AUTH_HOST=oauth.$DOMAIN_NAME
      - URL_PATH=/_oauth
      - LOG_LEVEL=warn
      - LOG_FORMAT=text
      - LIFETIME=2592000  # 30 days
      - DEFAULT_ACTION=auth
      - DEFAULT_PROVIDER=google
    secrets:
      - source: traefik-forward-auth
        target: /config
    labels:
      - "traefik.enable=true"
      # HTTP Routers
      - "traefik.http.routers.oauth-rtr.entrypoints=https"
      - "traefik.http.routers.oauth-rtr.rule=Host(`oauth.$DOMAIN_NAME`)"
      # HTTP Services
      - "traefik.http.routers.oauth-rtr.service=oauth-svc"
      - "traefik.http.services.oauth-svc.loadbalancer.server.port=4181"
      # Middlewares
      - "traefik.http.routers.oauth-rtr.middlewares=chain-oauth@file"

  crowdsec:
    <<: *network-sec
    container_name: crowdsec
    image: crowdsecurity/crowdsec:latest
    ports:
      - 8080:8080
    environment:
      COLLECTIONS: "crowdsecurity/traefik crowdsecurity/http-cve crowdsecurity/whitelist-good-actors crowdsecurity/iptables crowdsecurity/linux crowdsecurity/nginx crowdsecurity/sshd"
      GUID: "${GID-1000}"
    volumes:
      - $DOCKER_DIR/logs/traefik:/logs/traefik:ro
      - /var/log:/var/log:ro
      - $DOCKER_DIR/app-data/crowdsec/data:/var/lib/crowdsec/data
      - $DOCKER_DIR/app-data/crowdsec/config:/etc/crowdsec
    labels:
      # Backup
      - "backup.stop"

  traefik-bouncer:
    <<: *network-sec
    container_name: traefik-bouncer
    image: fbonalair/traefik-crowdsec-bouncer:latest
    environment:
      GIN_MODE: release
      CROWDSEC_BOUNCER_API_KEY: $CROWDSEC_BOUNCER_TRAEFIK_API_KEY
      CROWDSEC_AGENT_HOST: crowdsec:8080
      CROWDSEC_BOUNCER_LOG_LEVEL: 2

  # FRONTENDS

  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    container_name: homepage
    networks:
      - t2_proxy
      - socket_proxy
    security_opt:
      - no-new-privileges=true
    restart: unless-stopped
    volumes:
      - $DOCKER_DIR/app-data/homepage:/app/config
      - $DOCKER_DIR/app-data/homepage/icons:/app/public/icons
      - $MEDIA_DIR:/storage
    environment:
      <<: *default-tz-puid-pgid
    labels:
      - "traefik.enable=true"
      ## HTTP Routers
      - "traefik.http.routers.homepage-rtr.entrypoints=https"
      - "traefik.http.routers.homepage-rtr.rule=Host(`$DOMAIN_NAME`) || Host(`www.$DOMAIN_NAME`)"
      ## Middlewares
      - "traefik.http.middlewares.homepage-redirect.redirectregex.regex=^https?://$DOMAIN_NAME(/.*)?$$"
      - "traefik.http.middlewares.homepage-redirect.redirectregex.replacement=https://www.$DOMAIN_NAME$${1}"
      - "traefik.http.middlewares.homepage-redirect.redirectregex.permanent=true"
      - "traefik.http.routers.homepage-rtr.middlewares=chain-oauth@file,homepage-redirect"
      ## HTTP Services
      - "traefik.http.routers.homepage-rtr.service=homepage-svc"
      - "traefik.http.services.homepage-svc.loadbalancer.server.port=3000"

  overseerr:
    <<: *network-sec
    image: sctx/overseerr:latest
    container_name: overseerr
    volumes:
      - $DOCKER_DIR/app-data/overseerr:/app/config
      # Keep backups smaller/simpler. This data can be regenerated/redownloaded by Overseerr.
      - $DOCKER_DIR/temp/overseerr/cache:/app/config/cache
    environment:
      <<: *default-tz-puid-pgid
    labels:
      - "traefik.enable=true"
      # HTTP Routers
      - "traefik.http.routers.overseerr-rtr.entrypoints=https"
      - "traefik.http.routers.overseerr-rtr.rule=Host(`request.$DOMAIN_NAME`)"
      # Middlewares
      - "traefik.http.routers.overseerr-rtr.middlewares=chain-no-auth@file"
      # HTTP Services
      - "traefik.http.routers.overseerr-rtr.service=overseerr-svc"
      - "traefik.http.services.overseerr-svc.loadbalancer.server.port=5055"
      # Backup
      - "backup.stop"

  plexms:
    image: plexinc/pms-docker:latest
    container_name: plexms
    restart: unless-stopped
    network_mode: host
    security_opt:
      - no-new-privileges=true
    volumes:
      - $DOCKER_DIR/app-data/plexms:/config
      - /dev/shm:/transcode  # offload transcoding to RAM
      - $MEDIA_DIR:/media
      # Keep backups smaller/simpler. This data can be regenerated/redownloaded by Plex.
      - $DOCKER_DIR/temp/plexms/Cache:/config/Library/Application Support/Plex Media Server/Cache
      - $DOCKER_DIR/temp/plexms/Metadata:/config/Library/Application Support/Plex Media Server/Metadata
      - $DOCKER_DIR/temp/plexms/Media:/config/Library/Application Support/Plex Media Server/Media
    devices:
      - /dev/dri:/dev/dri  # for hardware transcoding
    secrets:
      - plex_claim
    environment:
      TZ: $TZ
      PLEX_CLAIM_FILE: /run/secrets/plex_claim
      PLEX_UID: $PUID
      PLEX_GID: $PGID
    labels:
      # Backup
      - "backup.stop"

  mealie:
    <<: *network-sec
    container_name: mealie
    image: hkotel/mealie:latest
    volumes:
      - $DOCKER_DIR/app-data/mealie:/app/data
    environment:
      <<: *default-tz-puid-pgid
      RECIPE_PUBLIC: "true"
      RECIPE_SHOW_NUTRITION: "false"
      RECIPE_DISABLE_COMMENTS: "true"
    labels:
      - "traefik.enable=true"
      # HTTP Routers
      - "traefik.http.routers.mealie-rtr.entrypoints=https"
      - "traefik.http.routers.mealie-rtr.rule=Host(`recipes.$DOMAIN_NAME`)"
      # Middlewares
      - "traefik.http.routers.mealie-rtr.middlewares=chain-no-auth@file"
      # HTTP Serices
      - "traefik.http.routers.mealie-rtr.service=mealie-svc"
      - "traefik.http.services.mealie-svc.loadbalancer.server.port=9000"
      # Backup
      - "backup.stop"

  metube:
    <<: *network-sec
    container_name: metube
    image: alexta69/metube:latest
    volumes:
      - $DOCKER_DIR/app-data/metube:/downloads
    environment:
      UID: $PUID
      GID: $PGID
      DELETE_FILE_ON_TRASHCAN: "true"
    labels:
      - "traefik.enable=true"
      # HTTP Routers
      - "traefik.http.routers.metube-rtr.entrypoints=https"
      - "traefik.http.routers.metube-rtr.rule=Host(`metube.$DOMAIN_NAME`)"
      # Middlewares
      - "traefik.http.routers.metube-rtr.middlewares=chain-oauth@file"
      # HTTP Serices
      - "traefik.http.routers.metube-rtr.service=metube-svc"
      - "traefik.http.services.metube-svc.loadbalancer.server.port=8081"

  calibre:
    <<: *network-sec
    image: linuxserver/calibre:latest
    container_name: calibre
    environment:
      <<: *default-tz-puid-pgid
      CALIBRE_OVERRIDE_DATABASE_PATH: /config/metadata.db
    volumes:
      - $DOCKER_DIR/app-data/calibre:/config
      - $MEDIA_DIR/books:/books
    labels:
      - "traefik.enable=true"
      # HTTP Routers
      - "traefik.http.routers.calibre-rtr.entrypoints=https"
      - "traefik.http.routers.calibre-rtr.rule=Host(`calibre.$DOMAIN_NAME`)"
      # Middlewares
      - "traefik.http.routers.calibre-rtr.middlewares=chain-oauth@file"
      # HTTP Services
      - "traefik.http.routers.calibre-rtr.service=calibre-svc"
      - "traefik.http.services.calibre-svc.loadbalancer.server.port=8080"
      # Backup
      - "backup.stop"

  calibre-web:
    <<: *network-sec
    image: linuxserver/calibre-web:latest
    container_name: calibre-web
    environment:
      <<: *default-tz-puid-pgid
    volumes:
      - $DOCKER_DIR/app-data/calibre-web:/config
      - $MEDIA_DIR/books:/books
      - $DOCKER_DIR/app-data/calibre/metadata.db:/books/metadata.db
    labels:
      - "traefik.enable=true"
      # HTTP Routers
      - "traefik.http.routers.calibre-web-rtr.entrypoints=https"
      - "traefik.http.routers.calibre-web-rtr.rule=Host(`books.$DOMAIN_NAME`)"
      # Middlewares
      - "traefik.http.middlewares.kobo-sync-headers.headers.customrequestheaders.X-Scheme=https"
      - "traefik.http.routers.calibre-web-rtr.middlewares=kobo-sync-headers,chain-no-auth@file"
      # HTTP Services
      - "traefik.http.routers.calibre-web-rtr.service=calibre-web-svc"
      - "traefik.http.services.calibre-web-svc.loadbalancer.server.port=8083"
      # Backup
      - "backup.stop"

  homeassistant:
    image: linuxserver/homeassistant:latest
    container_name: homeassistant
    security_opt:
      - no-new-privileges=true
    restart: unless-stopped
      #network_mode: host
    networks:
      - t2_proxy
    environment:
      <<: *default-tz-puid-pgid
    volumes:
      - $DOCKER_DIR/app-data/homeassistant:/config
    labels:
      - "traefik.enable=true"
      # HTTP Routers
      - "traefik.http.routers.homeassistant.entrypoints=https"
      - "traefik.http.routers.homeassistant.rule=Host(`hass.$DOMAIN_NAME`)"
      # Middlewares
      - "traefik.http.routers.homeassistant.middlewares=chain-oauth@file"
      # HTTP Services
      - "traefik.http.routers.homeassistant.service=homeassistant-svc"
      - "traefik.http.services.homeassistant-svc.loadbalancer.server.port=8123"
 
  # DOWNLOADERS

  sabnzbd:
    <<: *network-sec
    image: linuxserver/sabnzbd:latest
    container_name: sabnzbd
    volumes:
      - $DOCKER_DIR/app-data/sabnzbd:/config
      - $DOWNLOAD_DIR:/downloads
    environment:
      <<: *default-tz-puid-pgid
      UMASK_SET: 002
    labels:
      - "traefik.enable=true"
      # HTTP Routers Auth
      - "traefik.http.routers.sabnzbd-rtr.entrypoints=https"
      - "traefik.http.routers.sabnzbd-rtr.rule=Host(`sabnzbd.$DOMAIN_NAME`)"
      # Middlewares
      - "traefik.http.routers.sabnzbd-rtr.middlewares=chain-oauth@file"
      # HTTP Services
      - "traefik.http.routers.sabnzbd-rtr.service=sabnzbd-svc"
      - "traefik.http.services.sabnzbd-svc.loadbalancer.server.port=8080"
      # Backup
      - "backup.stop"

  deluge:
    <<: *network-sec
    image: linuxserver/deluge:latest
    container_name: deluge
    environment:
      <<: *default-tz-puid-pgid
      UMASK_SET: 022
    volumes:
      - $DOCKER_DIR/app-data/deluge:/config
      - $DOWNLOAD_DIR:/downloads
    labels:
      - "traefik.enable=true"
      # HTTP Routers
      - "traefik.http.routers.deluge-rtr.entrypoints=https"
      - "traefik.http.routers.deluge-rtr.rule=Host(`deluge.$DOMAIN_NAME`)"
      # Middlewares
      - "traefik.http.routers.deluge-rtr.middlewares=chain-oauth@file"
      # HTTP Services
      - "traefik.http.routers.deluge-rtr.service=deluge-svc"
      - "traefik.http.services.deluge-svc.loadbalancer.server.port=8112"

  # PVRS

  prowlarr:
    <<: *network-sec
    image: linuxserver/prowlarr:latest
    container_name: prowlarr
    volumes:
      - $DOCKER_DIR/app-data/prowlarr:/config
    environment:
      <<: *default-tz-puid-pgid
    labels:
      - "traefik.enable=true"
      # HTTP Routers
      - "traefik.http.routers.prowlarr-rtr.entrypoints=https"
      - "traefik.http.routers.prowlarr-rtr.rule=Host(`prowlarr.$DOMAIN_NAME`)"
      # Middlewares
      - "traefik.http.routers.prowlarr-rtr.middlewares=chain-oauth@file"
      # HTTP Services
      - "traefik.http.routers.prowlarr-rtr.service=prowlarr-svc"
      - "traefik.http.services.prowlarr-svc.loadbalancer.server.port=9696"
      # Backup
      - "backup.stop"

  recyclarr:
    <<: *network-sec
    image: recyclarr/recyclarr:latest
    container_name: recyclarr
    volumes:
      - $DOCKER_DIR/app-data/recyclarr:/config
    user: $PUID:$PGID
    environment:
      <<: *default-tz-puid-pgid
        
  radarr:
    <<: *network-sec
    image: linuxserver/radarr:latest
    container_name: radarr
    volumes:
      - $DOCKER_DIR/app-data/radarr:/config
      - $DOWNLOAD_DIR:/downloads
      - $MEDIA_DIR/movies:/movies
      - "/etc/localtime:/etc/localtime:ro"
      # Keep backups smaller/simpler. This data can be regenerated/redownloaded by Radarr.
      - $DOCKER_DIR/temp/radarr/MediaCover:/config/MediaCover
    environment:
      <<: *default-tz-puid-pgid
    labels:
      - "traefik.enable=true"
      # HTTP Routers Auth Bypass
      - "traefik.http.routers.radarr-rtr-bypass.entrypoints=https"
      - "traefik.http.routers.radarr-rtr-bypass.rule=Host(`radarr.$DOMAIN_NAME`) && (Headers(`X-Api-Key`, `$RADARR_API_KEY`) || Query(`apikey`, `$RADARR_API_KEY`))"
      - "traefik.http.routers.radarr-rtr-bypass.priority=100"
      # HTTP Routers Auth
      - "traefik.http.routers.radarr-rtr.entrypoints=https"
      - "traefik.http.routers.radarr-rtr.rule=Host(`radarr.$DOMAIN_NAME`)"
      - "traefik.http.routers.radarr-rtr.priority=99"
      # Middlewares
      - "traefik.http.routers.radarr-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.radarr-rtr-bypass.middlewares=chain-no-auth@file"
      # HTTP Services
      - "traefik.http.routers.radarr-rtr.service=radarr-svc"
      - "traefik.http.routers.radarr-rtr-bypass.service=radarr-svc"
      - "traefik.http.services.radarr-svc.loadbalancer.server.port=7878"
      # Backup
      - "backup.stop"

  sonarr:
    <<: *network-sec
    image: linuxserver/sonarr:latest
    container_name: sonarr
    volumes:
      - $DOCKER_DIR/app-data/sonarr:/config
      - $DOWNLOAD_DIR:/downloads
      - $MEDIA_DIR/tv:/tv
      - "/etc/localtime:/etc/localtime:ro"
      # Keep backups smaller/simpler. This data can be regenerated/redownloaded by Sonarr.
      - $DOCKER_DIR/temp/sonarr/MediaCover:/config/MediaCover
    environment:
      <<: *default-tz-puid-pgid
    labels:
      - "traefik.enable=true"
      # HTTP Routers Auth Bypass
      - "traefik.http.routers.sonarr-rtr-bypass.entrypoints=https"
      - "traefik.http.routers.sonarr-rtr-bypass.rule=Host(`sonarr.$DOMAIN_NAME`) && (Headers(`X-Api-Key`, `$SONARR_API_KEY`) || Query(`apikey`, `$SONARR_API_KEY`))"
      - "traefik.http.routers.sonarr-rtr-bypass.priority=100"
      # HTTP Routers Auth
      - "traefik.http.routers.sonarr-rtr.entrypoints=https"
      - "traefik.http.routers.sonarr-rtr.rule=Host(`sonarr.$DOMAIN_NAME`)"
      - "traefik.http.routers.sonarr-rtr.priority=99"
      # Middlewares
      - "traefik.http.routers.sonarr-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.sonarr-rtr-bypass.middlewares=chain-no-auth@file"
      # HTTP Services
      - "traefik.http.routers.sonarr-rtr.service=sonarr-svc"
      - "traefik.http.routers.sonarr-rtr-bypass.service=sonarr-svc"
      - "traefik.http.services.sonarr-svc.loadbalancer.server.port=8989"
      # Backup
      - "backup.stop"

  lidarr:
    <<: *network-sec
    image: linuxserver/lidarr:latest
    container_name: lidarr
    volumes:
      - $DOCKER_DIR/app-data/lidarr:/config
      - $DOWNLOAD_DIR:/downloads
      - $MEDIA_DIR/music:/music
      - "/etc/localtime:/etc/localtime:ro"
      # Keep backups smaller/simpler. This data can be regenerated/redownloaded by Lidarr.
      - $DOCKER_DIR/temp/lidarr/MediaCover:/config/MediaCover
    environment:
      <<: *default-tz-puid-pgid
    labels:
      - "traefik.enable=true"
      ## HTTP Routers Auth Bypass
      - "traefik.http.routers.lidarr-rtr-bypass.entrypoints=https"
      - "traefik.http.routers.lidarr-rtr-bypass.rule=Host(`lidarr.$DOMAIN_NAME`) && (Headers(`X-Api-Key`, `$LIDARR_API_KEY`) || Query(`apikey`, `$LIDARR_API_KEY`))"
      - "traefik.http.routers.lidarr-rtr-bypass.priority=100"
      ## HTTP Routers Auth
      - "traefik.http.routers.lidarr-rtr.entrypoints=https"
      - "traefik.http.routers.lidarr-rtr.rule=Host(`lidarr.$DOMAIN_NAME`)"
      - "traefik.http.routers.lidarr-rtr.priority=99"
      ## Middlewares
      - "traefik.http.routers.lidarr-rtr-bypass.middlewares=chain-no-auth@file"
      - "traefik.http.routers.lidarr-rtr.middlewares=chain-oauth@file"
      ## HTTP Services
      - "traefik.http.routers.lidarr-rtr.service=lidarr-svc"
      - "traefik.http.routers.lidarr-rtr-bypass.service=lidarr-svc"
      - "traefik.http.services.lidarr-svc.loadbalancer.server.port=8686"
      # Backup
      - "backup.stop"

  readarr:
    <<: *network-sec
    image: linuxserver/readarr:develop
    container_name: readarr
    environment:
      <<: *default-tz-puid-pgid
    volumes:
      - $DOCKER_DIR/app-data/readarr:/config
      - $DOWNLOAD_DIR:/downloads
      - $MEDIA_DIR/books:/books
    labels:
      - "traefik.enable=true"
      # HTTP Routers
      - "traefik.http.routers.readarr-rtr.entrypoints=https"
      - "traefik.http.routers.readarr-rtr.rule=Host(`readarr.$DOMAIN_NAME`)"
      # Middlewares
      - "traefik.http.routers.readarr-rtr.middlewares=chain-oauth@file"
      # HTTP Services
      - "traefik.http.routers.readarr-rtr.service=readarr-svc"
      - "traefik.http.services.readarr-svc.loadbalancer.server.port=8787"
      # Backup
      - "backup.stop"

  bazarr:
    <<: *network-sec
    image: linuxserver/bazarr:latest
    container_name: bazarr
    volumes:
      - $DOCKER_DIR/app-data/bazarr:/config
      - $MEDIA_DIR/tv:/tv
      - $MEDIA_DIR/movies:/movies
    environment:
      <<: *default-tz-puid-pgid
    labels:
      - "traefik.enable=true"
      # HTTP Routers
      - "traefik.http.routers.bazarr-rtr.entrypoints=https"
      - "traefik.http.routers.bazarr-rtr.rule=Host(`bazarr.$DOMAIN_NAME`)"
      # Middlewares
      - "traefik.http.routers.bazarr-rtr.middlewares=chain-oauth@file"
      # HTTP Services
      - "traefik.http.routers.bazarr-rtr.service=bazarr-svc"
      - "traefik.http.services.bazarr-svc.loadbalancer.server.port=6767"
      # Backup
      - "backup.stop"

  # UTILITY

  dozzle:
    <<: *network-sec
    container_name: dozzle
    image: amir20/dozzle:latest
    networks:
      - t2_proxy
      - socket_proxy
    environment:
      DOZZLE_LEVEL: info
      DOZZLE_TAILSIZE: 300
      DOZZLE_FILTER: status=running
      DOCKER_HOST: $SOCKET_PROXY
    labels:
      - "traefik.enable=true"
      # HTTP Routers
      - "traefik.http.routers.dozzle-rtr.entrypoints=https"
      - "traefik.http.routers.dozzle-rtr.rule=Host(`dozzle.$DOMAIN_NAME`)"
      # Middlewares
      - "traefik.http.routers.dozzle-rtr.middlewares=chain-oauth@file"
      # HTTP Services
      - "traefik.http.routers.dozzle-rtr.service=dozzle-svc"
      - "traefik.http.services.dozzle-svc.loadbalancer.server.port=8080"

  glances:
    <<: *network-sec
    image: nicolargo/glances:latest
    container_name: glances
    privileged: true
    networks:
      - t2_proxy
      - socket_proxy
    pid: host
    environment:
      TZ: $TZ
      GLANCES_OPT: -w --fs-free-space
      DOCKER_HOST: $SOCKET_PROXY
    volumes:
      - $MEDIA_DIR:/data/hdd1:ro
      - $DOCKER_DIR/app-data/glances/glances.conf:/etc/glances.conf
    labels:
      - "traefik.enable=true"
      # HTTP Routers
      - "traefik.http.routers.glances-rtr.entrypoints=https"
      - "traefik.http.routers.glances-rtr.rule=Host(`glances.$DOMAIN_NAME`)"
      # Middlewares
      - "traefik.http.routers.glances-rtr.middlewares=chain-oauth@file"
      # HTTP Services
      - "traefik.http.routers.glances-rtr.service=glances-svc"
      - "traefik.http.services.glances-svc.loadbalancer.server.port=61208"

  watchtower:
    <<: *network-sec
    container_name: watchtower
    image: containrrr/watchtower:latest
    networks:
      - socket_proxy
    environment:
      <<: *default-tz-puid-pgid
      DOCKER_HOST: $SOCKET_PROXY
      WATCHTOWER_HTTP_API_METRICS: true
      WATCHTOWER_HTTP_API_TOKEN: $WATCHTOWER_TOKEN
      WATCHTOWER_SCHEDULE: "0 0 2 * * *"
      WATCHTOWER_CLEANUP: true
    ports:
      - 8085:8080

  speedtest:
    <<: *network-sec
    container_name: speedtest
    image: ghcr.io/alexjustesen/speedtest-tracker:latest
    volumes:
      - $DOCKER_DIR/app-data/speedtest:/config
    environment:
      <<: *default-tz-puid-pgid
      CACHE_DRIVER: file
    labels:
      - "traefik.enable=true"
      # HTTP Routers
      - "traefik.http.routers.speedtest-rtr.entrypoints=https"
      - "traefik.http.routers.speedtest-rtr.rule=Host(`speedtest.$DOMAIN_NAME`)"
      # Middlewares
      - "traefik.http.routers.speedtest-rtr.middlewares=chain-oauth@file"
      # HTTP Services
      - "traefik.http.routers.speedtest-rtr.service=speedtest-svc"
      - "traefik.http.services.speedtest-svc.loadbalancer.server.port=80"
      # Backup
      - "backup.stop"

  tautulli:
    <<: *network-sec
    image: linuxserver/tautulli:latest
    container_name: tautulli
    volumes:
      - $DOCKER_DIR/app-data/tautulli/config:/config
      - $DOCKER_DIR/app-data/plexms/Library/Application Support/Plex Media Server/Logs:/logs:ro  # For tautulli Plex log viewer
      # Keep backups smaller/simpler. This data can be regenerated/redownloaded by Tautulli.
      - $DOCKER_DIR/temp/tautulli/cache:/config/cache
    environment:
      <<: *default-tz-puid-pgid
    labels:
      - "traefik.enable=true"
      # HTTP Routers Auth Bypass
      - "traefik.http.routers.tautulli-rtr-bypass.entrypoints=https"
      - "traefik.http.routers.tautulli-rtr-bypass.rule=Host(`tautulli.$DOMAIN_NAME`) && Query(`apikey`, `$TAUTULLI_DEVICE_TOKEN`)"
      - "traefik.http.routers.tautulli-rtr-bypass.priority=100"
      # HTTP Routers
      - "traefik.http.routers.tautulli-rtr.entrypoints=https"
      - "traefik.http.routers.tautulli-rtr.rule=Host(`tautulli.$DOMAIN_NAME`)"
      - "traefik.http.routers.tautulli-rtr.priority=99"
      # Middlewares
      - "traefik.http.routers.tautulli-rtr-bypass.middlewares=chain-no-auth@file"
      - "traefik.http.routers.tautulli-rtr.middlewares=chain-oauth@file"
      # HTTP Services
      - "traefik.http.routers.tautulli-rtr.service=tautulli-svc"
      - "traefik.http.routers.tautulli-rtr-bypass.service=tautulli-svc"
      - "traefik.http.services.tautulli-svc.loadbalancer.server.port=8181"
      # Backup
      - "backup.stop"

  pal:
    <<: *network-sec
    image: remirigal/plex-auto-languages:latest
    container_name: plex-auto-languages
    secrets:
      - plex_token
    environment:
      <<: *default-tz-puid-pgid
      PLEX_URL: http://172.17.0.1:32400
      PLEX_TOKEN_FILE: /run/secrets/plex_token
      UPDATE_LEVEL: season
      IGNORE_TAGS: PAL_IGNORE
